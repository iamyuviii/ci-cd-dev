FROM node:20.12.0-alpine3.19

# Create app directory
WORKDIR /usr/src/app

# Copy root files
COPY package.json package-lock.json turbo.json tsconfig.json ./

# Copy only the needed parts of the app
COPY apps ./apps
COPY packages ./packages

# Install dependencies
RUN npm install
RUN npm install @prisma/client

# Copy prisma folder explicitly (just to be safe)
# This ensures prisma CLI works even if prisma is nested
RUN ls ./packages/db/prisma  # for debug

# Generate Prisma Client with correct schema
RUN npx prisma generate --schema=./packages/db/prisma/schema.prisma

# Build the application
RUN npm run build

# Run the app
CMD ["npm", "run", "start-user-app"]
